<template>
    <div>
        <div class="breadcrumb-area gray-bg-7">
            <div class="container">
                <div class="breadcrumb-content">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li class="active">My Account</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- my account start -->
        <div class="checkout-area pb-45 pt-65">
            <div class="container">
                <div class="row">
                    <div class="ms-auto me-auto col-lg-9">
                        <div class="checkout-wrapper">
                            <div id="faq" class="panel-group">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h5 class="panel-title">
                                            <span>1</span>
                                            <a
                                                data-bs-toggle="collapse"
                                                href="#my-account-1"
                                                >Edit your account information
                                            </a>
                                        </h5>
                                    </div>
                                    <div
                                        id="my-account-1"
                                        class="panel-collapse collapse show"
                                        data-bs-parent="#faq"
                                    >
                                        <div class="panel-body">
                                            <div
                                                class="billing-information-wrapper"
                                            >
                                                <div
                                                    class="account-info-wrapper"
                                                >
                                                    <h4>
                                                        My Account Information
                                                    </h4>
                                                    <h5>
                                                        Your Personal Details
                                                    </h5>
                                                </div>
                                                <div class="row">
                                                    <div
                                                        class="col-lg-6 col-md-6"
                                                    >
                                                        <div
                                                            class="billing-info"
                                                        >
                                                            <label
                                                                >First
                                                                Name</label
                                                            >
                                                            <input
                                                                type="text"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-lg-6 col-md-6"
                                                    >
                                                        <div
                                                            class="billing-info"
                                                        >
                                                            <label
                                                                >Last
                                                                Name</label
                                                            >
                                                            <input
                                                                type="text"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-lg-12 col-md-12"
                                                    >
                                                        <div
                                                            class="billing-info"
                                                        >
                                                            <label
                                                                >Email
                                                                Address</label
                                                            >
                                                            <input
                                                                type="email"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-lg-6 col-md-6"
                                                    >
                                                        <div
                                                            class="billing-info"
                                                        >
                                                            <label
                                                                >Telephone</label
                                                            >
                                                            <input
                                                                type="text"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-lg-6 col-md-6"
                                                    >
                                                        <div
                                                            class="billing-info"
                                                        >
                                                            <label>Fax</label>
                                                            <input
                                                                type="text"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="billing-back-btn">
                                                    <div class="billing-back">
                                                        <a href="#"
                                                            ><i
                                                                class="ion-arrow-up-c"
                                                            ></i>
                                                            back</a
                                                        >
                                                    </div>
                                                    <div class="billing-btn">
                                                        <button type="submit">
                                                            Continue
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h5 class="panel-title">
                                            <span>2</span>
                                            <a
                                                data-bs-toggle="collapse"
                                                href="#my-account-2"
                                                >Change your password
                                            </a>
                                        </h5>
                                    </div>
                                    <div
                                        id="my-account-2"
                                        class="panel-collapse collapse"
                                        data-bs-parent="#faq"
                                    >
                                        <div class="panel-body">
                                            <div
                                                class="billing-information-wrapper"
                                            >
                                                <div
                                                    class="account-info-wrapper"
                                                >
                                                    <h4>Change Password</h4>
                                                    <h5>Your Password</h5>
                                                </div>
                                                <div class="row">
                                                    <div
                                                        class="col-lg-12 col-md-12"
                                                    >
                                                        <div
                                                            class="billing-info"
                                                        >
                                                            <label
                                                                >Password</label
                                                            >
                                                            <input
                                                                type="password"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div
                                                        class="col-lg-12 col-md-12"
                                                    >
                                                        <div
                                                            class="billing-info"
                                                        >
                                                            <label
                                                                >Password
                                                                Confirm</label
                                                            >
                                                            <input
                                                                type="password"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="billing-back-btn">
                                                    <div class="billing-back">
                                                        <a href="#"
                                                            ><i
                                                                class="ion-arrow-up-c"
                                                            ></i>
                                                            back</a
                                                        >
                                                    </div>
                                                    <div class="billing-btn">
                                                        <button type="submit">
                                                            Continue
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h5 class="panel-title">
                                            <span>3</span>
                                            <a
                                                data-bs-toggle="collapse"
                                                href="#my-account-3"
                                                >Modify your address book
                                                entries
                                            </a>
                                        </h5>
                                    </div>
                                    <div
                                        id="my-account-3"
                                        class="panel-collapse collapse"
                                        data-bs-parent="#faq"
                                    >
                                        <div class="panel-body">
                                            <div
                                                class="billing-information-wrapper"
                                            >
                                                <div
                                                    class="account-info-wrapper"
                                                >
                                                    <h4>
                                                        Address Book Entries
                                                    </h4>
                                                </div>
                                                <div class="entries-wrapper">
                                                    <div class="row">
                                                        <div
                                                            class="
                                col-lg-6 col-md-6
                                d-flex
                                align-items-center
                                justify-content-center
                              "
                                                        >
                                                            <div
                                                                class="entries-info text-center"
                                                            >
                                                                <p>
                                                                    Farhana
                                                                    hayder
                                                                    (shuvo)
                                                                </p>
                                                                <p>hastech</p>
                                                                <p>
                                                                    Road#1 ,
                                                                    Block#c
                                                                </p>
                                                                <p>Rampura.</p>
                                                                <p>Dhaka</p>
                                                                <p>
                                                                    Bangladesh
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div
                                                            class="
                                col-lg-6 col-md-6
                                d-flex
                                align-items-center
                                justify-content-center
                              "
                                                        >
                                                            <div
                                                                class="entries-edit-delete text-center"
                                                            >
                                                                <a
                                                                    class="edit"
                                                                    href="#"
                                                                    >Edit</a
                                                                >
                                                                <a href="#"
                                                                    >Delete</a
                                                                >
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="billing-back-btn">
                                                    <div class="billing-back">
                                                        <a href="#"
                                                            ><i
                                                                class="ion-arrow-up-c"
                                                            ></i>
                                                            back</a
                                                        >
                                                    </div>
                                                    <div class="billing-btn">
                                                        <button type="submit">
                                                            Continue
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h5 class="panel-title">
                                            <span>4</span>
                                            <router-link to="/wishlist"
                                                >Modify your wish list
                                            </router-link>
                                        </h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import PreLoader from "../components/commons/PreLoader";
import { mapGetters, mapActions } from "vuex";
import { baseUrl } from "../../api";
import * as auth from "../../services/auth";
import * as userService from "../../services/user";
import {
    required,
    sameAs,
    minLength,
    maxLength
} from "vuelidate/lib/validators";

export default {
    name: "Account",
    metaInfo: {
        title: "Account",
        titleTemplate: "%s - Faadaakaa Ecommerce"
    },
    components: {
        PreLoader
    },
    watch: {
        wishList: function() {
            this.makeCartItems();
        }
    },
    computed: {
        ...mapGetters("user", ["user", "getShippingAddesses", "getOrders"]),
        ...mapGetters("wishlist", ["wishList"])
    },
    validations: {
        userprofile: {
            first_name: { required },
            last_name: { required },
            email: { required },
            phone: { required },
            old_password: {
                minLength: minLength(8)
            },
            password: {
                minLength: minLength(8)
            },
            confirm_password: {
                sameAsPassword: sameAs("password")
            }
        },
        billing: {
            country: { required },
            state: { required },
            city: { required },
            address: { required }
        },
        shipping: {
            country: { required },
            state: { required },
            city: { required },
            address: { required },
            phone: { required, maxLength: maxLength(11) },
            postal_code: { required }
        }
    },
    created: function() {
        this.userprofile.first_name = auth.getUser().first_name;
        this.userprofile.last_name = auth.getUser().last_name;
        this.userprofile.email = auth.getUser().email;
        this.userprofile.phone = auth.getUser().phone_number;
        this.billing.city = auth.getUser().city;
        this.billing.address = auth.getUser().address;
        this.billing.state = auth.getUser().state;
        //this.billing.country = auth.getUser().country;
    },
    data: function() {
        return {
            isSticky: false,
            loading: false,
            baseUrl: baseUrl,
            wishItems: [],
            currentProduct: null,
            userprofile: {
                first_name: "",
                last_name: "",
                email: "",
                phone: "",
                old_password: "",
                password: "",
                confirm_password: ""
            },
            shipping: {
                address: "",
                state: "",
                country: "Nigeria",
                postal_code: "",
                phone: "",
                city: ""
            },
            billing: {
                address: "",
                state: "",
                city: "",
                country: "Nigeria"
            },
            errors: {}
        };
    },
    mounted: function() {
        this.resizeHandler();
        this.makeCartItems();
        window.addEventListener("resize", this.resizeHandler, {
            passive: true
        });
    },
    destroyed: function() {
        window.removeEventListener("resize", this.resizeHandler);
    },
    methods: {
        ...mapActions("user", ["userLogin", "userLogout"]),
        ...mapActions("notification", ["addNotification"]),
        ...mapActions("wishlist", ["removeFromWishlist"]),
        ...mapActions("cart", ["addToCart"]),
        makeCartItems: function() {
            this.wishItems = this.wishList;
            this.wishItems = this.wishList.reduce((acc, product) => {
                let minPrice = 0,
                    maxPrice = 0;

                /*if (!product.price) {
          minPrice = product.variants[0].price;
          product.variants.forEach((item) => {
            let itemPrice = item.is_sale ? item.sale_price : item.price;
            if (minPrice > itemPrice) minPrice = itemPrice;
            if (maxPrice < itemPrice) maxPrice = itemPrice;
          });
        }*/

                return [
                    ...acc,
                    {
                        ...product,
                        minPrice: minPrice,
                        maxPrice: maxPrice
                    }
                ];
            }, []);
        },
        openQuickview: function(product) {
            this.$modal.show(
                () => import("../../components/features/product/PvQuickview"),
                { slug: product.slug },
                {
                    width: "931",
                    height: "auto",
                    adaptive: true,
                    class: "quickview-modal"
                }
            );
        },
        addCart: function(product) {
            this.currentProduct = product;
            document.querySelector(".cart-message.removed").style.display =
                "none";
            document.querySelector(".cart-message.carted").style.display =
                "block";
            this.addToCart({ product: product });
            this.removeFromWishlist({ id: product.id });
        },
        removeWishlist: function(product) {
            this.currentProduct = product;
            document.querySelector(".cart-message.carted").style.display =
                "none";
            document.querySelector(".cart-message.removed").style.display =
                "block";
            this.removeFromWishlist({ id: product.id });
        },
        status(validation) {
            return {
                error: validation.$error
            };
        },
        checkRequired(validation) {
            if (!validation.$dirty && validation.$model == "") {
                return true;
            } else if (
                validation.$dirty &&
                validation.$error &&
                validation.$model == ""
            ) {
                return false;
            } else {
                return true;
            }
        },
        checkLength(validation) {
            if (!validation.$dirty && validation.$model == "") {
                return true;
            } else if (
                validation.$dirty &&
                validation.$error &&
                (!validation.minLength || !validation.maxLength)
            ) {
                return false;
            } else {
                return true;
            }
        },
        checkSame(validation) {
            if (!validation.$dirty && validation.$model == "") {
                return true;
            } else if (
                validation.$dirty &&
                validation.$error &&
                !validation.sameAsPassword
            ) {
                return false;
            } else {
                return true;
            }
        },
        updateProfile: async function() {
            let submit = document.getElementById("update_submit");
            this.$v.userprofile.$touch();
            if (this.$v.userprofile.$invalid) {
                return;
            }
            try {
                this.loading = true;
                const response = await userService.update(this.userprofile);
                console.log(response);
                this.userLogin(response.data.data.user);
                auth.setUser(response.data.data.user);
                this.addNotification({
                    type: "success",
                    message: response.data.data.message
                });
                submit.innerText = "Save Address";
                this.loading = false;
                this.password = "";
                this.old_password = "";
                this.confirm_password = "";
                this.$router.go();
            } catch (err) {
                this.loading = false;
                submit.innerText = "Save Address";
                console.log(err.response);
                this.addNotification({
                    type: "error",
                    message: err.response.data.data.message
                });
            }
        },
        updateBillingAddress: async function() {
            let submit = document.getElementById("billing_submit");
            this.$v.billing.$touch();
            if (this.$v.billing.$invalid) {
                return;
            }
            try {
                this.loading = true;
                submit.innerText = "Loading";
                const response = await userService.updateBilling(this.billing);
                console.log(response);
                this.userLogin(response.data.data.user);
                auth.setUser(response.data.data.user);
                this.addNotification({
                    type: "success",
                    message: response.data.data.message
                });
                this.billing.address = "";
                this.billing.city = "";
                this.billing.state = "";
                submit.innerText = "Save Address";
                this.loading = false;
                this.$router.go();
            } catch (err) {
                this.loading = false;
                submit.innerText = "Save Address";
                console.log(err.response);
                this.addNotification({
                    type: "error",
                    message: err.response.data.data.message
                });
            }
        },
        createShippingAddress: async function() {
            let submit = document.getElementById("shipping_submit");
            this.$v.shipping.$touch();
            if (this.$v.shipping.$invalid) {
                return;
            }
            try {
                this.loading = true;
                submit.innerText = "Loading";
                const response = await userService.createShipping(
                    this.shipping
                );
                console.log(response);
                this.userLogin(response.data.data.user);
                auth.setUser(response.data.data.user);
                this.addNotification({
                    type: "success",
                    message: response.data.data.message
                });
                this.shipping.postal_code = "";
                this.shipping.city = "";
                this.shipping.state = "";
                this.shipping.phone = "";
                submit.innerText = "Save Address";
                this.loading = false;
                this.$router.go();
            } catch (err) {
                this.loading = false;
                submit.innerText = "Save Address";
                console.log(err.response);
                this.addNotification({
                    type: "error",
                    message: err.response.data.data.message
                });
            }
        },
        logout: async function() {
            try {
                const response = await auth.logout();
                this.userLogout({});
                this.addNotification({
                    type: "success",
                    message: "Successfully logged out"
                });
                console.log(response);
                this.$router.push("/");
            } catch (err) {
                console.log(err.response);
            }
        },
        tabClicked: function(e) {
            let linkId = e.target.getAttribute("data-toggle");
            if (!linkId)
                linkId = e.target.parentNode.parentNode.getAttribute(
                    "data-toggle"
                );
            if (document.getElementById(linkId + "-tab"))
                document.getElementById(linkId + "-tab").click();
        },
        handler: function(e) {
            let linkId = e.target.getAttribute("href");
            if (document.querySelector(linkId + "-tab")) {
                document.querySelector(linkId + "-tab").classList.add("active");
            }
        },
        resizeHandler: function() {
            this.isSticky = window.innerWidth > 991 ? true : false;
        }
    }
};
</script>

<style scoped>
.error {
    border-color: red !important;
}
</style>
